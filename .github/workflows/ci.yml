name: Go Artisan CI/CD

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ] # 仅在打 tag (如 v1.0.0) 时触发发布流程
  pull_request:
    branches: [ "main" ]

jobs:
  # 任务1: 代码质量检查与测试
  lint-and-test:
    runs-on: ubuntu-latest
    services:
      # 在 CI 环境里起一个临时 MySQL 做集成测试
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: go_artisan
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    # 安装依赖
    - name: Download dependencies
      run: |
        go mod download
        go mod tidy

    # 代码风格检查
    - name: Run GolangCI-Lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: latest
        args: --timeout=5m --out-format=colored-line-number
        # 很多时候缓存会导致校验哈希不一致，如果遇到 cache error，暂时跳过缓存
        skip-cache: true
        # 也可以手动指定 skip-pkg-cache: true 如果仍然报错

    # 运行单元测试
    - name: Run Tests
      # 注入测试用的配置 (连接到 service 中的 mysql)
      run: |
        export DB_DSN="root:root@tcp(127.0.0.1:3306)/go_artisan?charset=utf8mb4&parseTime=True&loc=Local"
        go test -v ./...

  # 任务2: 构建与发布 (仅 Tag 触发)
  release:
    needs: lint-and-test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要权限创建 Release

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Get Version info
      id: vars
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    # 交叉编译 Linux, Windows, Mac
    - name: Build Binaries
      env:
        VERSION: ${{ steps.vars.outputs.VERSION }}
        COMMIT: ${{ steps.vars.outputs.COMMIT_HASH }}
        TIME: ${{ steps.vars.outputs.BUILD_TIME }}
      run: |
        LDFLAGS="-s -w -X 'go-artisan/pkg/version.GitTag=$VERSION' -X 'go-artisan/pkg/version.GitCommit=$COMMIT' -X 'go-artisan/pkg/version.BuildTime=$TIME'"

        # Linux AMD64
        GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/go-artisan-linux-amd64 ./cmd/server

        # Windows AMD64
        GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/go-artisan-windows-amd64.exe ./cmd/server

        # Mac ARM64
        GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o dist/go-artisan-darwin-arm64 ./cmd/server

    # 创建 GitHub Release
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        generate_release_notes: true
